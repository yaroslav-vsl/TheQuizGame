#include "MainFrame.h"
#include "StartPanel.h"
#include "GameBoardPanel.h"
#include "QuestionPanel.h"
#include "FractalPanel.h"
#include <fstream>
#include <sstream>
#include <wx/msgdlg.h>
#include <wx/file.h>
#include <wx/textfile.h>

wxBEGIN_EVENT_TABLE(MainFrame, wxFrame)
EVT_CLOSE(MainFrame::OnClose)
wxEND_EVENT_TABLE()

MainFrame::MainFrame()
    : wxFrame(NULL, wxID_ANY, "Викторина - Фракталы", wxDefaultPosition, wxSize(800, 600)),
    startPanel(NULL), gameBoardPanel(NULL), questionPanel(NULL), fractalPanel(NULL),
    m_correctAnswersCount(0), m_fractalType(FRACTAL_KOCH_SNOWFLAKE) // По умолчанию снежинка
{
    this->Maximize();
    //this->SetMinSize(this->GetSize());

    mainSizer = new wxBoxSizer(wxVERTICAL);
    SetSizer(mainSizer);

    LoadQuestions();
    ShowStartPanel();

    Center();
}

void MainFrame::ShowFractal()
{
    ClearMainSizer();
    fractalPanel = new FractalPanel(this, this); // Теперь используем общий FractalPanel
    mainSizer->Add(fractalPanel, 1, wxEXPAND);
    Layout();
}

void MainFrame::IncreaseCorrectAnswers()
{
    m_correctAnswersCount++;
}

void MainFrame::MarkQuestionAsAnswered(int questionIndex)
{
    if (questionIndex >= 0 && questionIndex < (int)questions.size()) {
        questions[questionIndex].answered = true;
    }
}

bool MainFrame::IsQuestionAnswered(int index) const
{
    if (index >= 0 && index < (int)questions.size()) {
        return questions[index].answered;
    }
    return false;
}

void MainFrame::LoadQuestions()
{
    questions.clear();
    CreateDefaultQuestions();
}

void MainFrame::CreateDefaultQuestions()
{
    questions.clear();

    // 16 вопросов для 16 кнопок
    std::vector<Question> defaultQuestions = {
        {"1. Поезд длиной 1 км едет со скоростью 1 км/мин. Ему нужно проехать через тоннель длиной 1 км. За сколько минут поезд полностью проедет тоннель?", {"За 1 минуту", "За 1.5 минуты", "За 2 минуты", "За 0.5 минуты"}, 2, false, "Чтобы поезд длиной 1 км полностью проехал тоннель длиной 1 км, его локомотив должен пройти путь, равный сумме длин поезда и тоннеля. Сначала локомотив въезжает в тоннель, и чтобы последний вагон выехал из тоннеля, локомотив должен проехать 1 км (длина тоннеля) + 1 км (длина поезда) = 2 км. При скорости 1 км/мин на это потребуется 2 минуты"},
        {"2. Цена товара сначала повысилась на 20%, а затем понизилась на 20%. Как изменилась конечная цена по сравнению с первоначальной?", {"Не изменилась", "Уменьшилась на 4%", "Увеличилась на 4%", "Уменьшилась на 2%"}, 2, false, "Пусть исходная цена Х. После повышения: X + 0.2X = 1.2Х. Понижение на 20 % применяется уже к новой цене : 1.2х - 0.2 * (1.2х) = 1.2х - 0.24Х = 0.96Х Сравниваем с исходной : 0.96Х - Х = -0.04х, то есть уменьшение на 4 %"},
        {"3. Какое из следующих чисел является наибольшим?", {"2^100", "3^75", "5^50", "10^25"}, 1, false},
        {"4. Анаконда весит 30 кг и еще половину своего веса. Сколько весит анаконда?", {"40 кг", "50 кг", "60 кг", "70 кг"}, 2, false, "Пусть вес анаконды = x кг. Уравнение: x = 30 + x / 2\nx - x / 2 = 30\nx / 2 = 30, х = 60"},
        {"5. Сколько корней имеет уравнение?", {"0", "1", "2", "Бесконечно много"}, 1, false, "Уравнение |x - 3| = распадается на два линейных: 1) х - 3 = 5 → X = 8; 2) x - 3 = -5 → X = -2."},
        {"6. Условие: Решите систему уравнений: 1) 2x + 3y = 19 2) 4х-у=3", {"(2; 5)", "(5; 2)", "(4; 3)", "(3; 4)"}, 0, false, "Воспользуемся методом сложения.\nУмножим второе уравнение на 3, чтобы уравнять коэффициенты при\nу : (4х - у = 3) * 3 → 12х - Зу = 9 2. Теперь сложим получившееся\nуравнение с первым :\n(2х + 3у) + (12х(12x - 3y) Зу) = 19 + 9\n14х = 28\nНаходим х :\n х = 28 / 14 = 2\nПодставим х = 2 во второе\nуравнение(оно проще) : 4 * 2 - у = 3→ 8 - у = 3 → у = 5"},
        {"7. В прямоугольном треугольнике катеты равны 6 см и 8 см. Чему равна гипотенуза?", {"9 см", "10 см", "12 см", "14 см"}, 1, false, "Решать по теореме Пифагора"},
        {"8. Дана последовательность чисел: 2, 3, 5, 7, 11, 13, 17, 19...Какое число следующее ?", {"21", "23", "25", "27"}, 1, false, "Это последовательность простых чисел — натуральных чисел, больших 1, которые делятся только на 1 и на самих себя.  Ряд простых чисел начинается так: 2, 3, 5, 7, 11, 13, 17, 19, 23, 29, ... Следовательно следующее число 23"},
        {"9. Продолжите последовательность: 1, 1, 2, 3, 5, 8, .- - ", {"10", "11", "12", "13"}, 3, false, "Это знаменитая последовательность Фибоначчи, где каждое следующее число равно сумме двух предыдущих: 5 + 8 = 13."},
        {"10. В четырехугольнике три угла равны 70°, 110° и 10°. Чему равен четвертый угол? ", {"70°", "90°", "110°", "180°"}, 0, false, "Сумма углов любого выпуклого четырехугольника равна 360°. Складываем известные углы: 70° + 110° + 110° = 290°. Четвертый угол равен 360° - 290° = 70°"},
        {"11. Когда отцу был 31 год, мне был 1 год. Сейчас отец старше меня в 2 раза. Сколько мне лет?", {"30 лет", "31 год", "32 года", "33 года"}, 0, false, "Разница в возрасте: 31 - 1 = 30 лет Пусть мне сейчас x лет, тогда отцу x + 30 лет Уравнение : x + 30 = 2x Решение : x = 30 лет"},
        {"12. У вас есть 8 одинаковых по виду монет. Одна из них фальшивая и легче остальных. У вас есть чашечные весы без гирь. За какое минимальное количество взвешиваний вы гарантированно найдете фальшивую монету?", {"За 1 взвешивание", "За 2 взвешивания", "За 3 взвешивания", "За 4 взвешивания"}, 1, false, "Делим 8 монет на три группы: 3, 3 и 2.Взвешиваем первые две группы по 3 монеты.Если весы в равновесии, фальшивая в третьей группе из 2 монет. Взвешиваем их — легкая и есть фальшивая.Если одна из групп из 3 монет легче, фальшивая в ней. Берем любые 2 из этих 3 и взвешиваем. Если одна легче — она фальшивая; если равны — фальшивая третья"},
        {"13. Условие: Площадь квадрата равна 64 см^2. Чему равен его периметр? ", {"16 см", "32 см", "64 см", "128 см"}, 1, false, "Площадь квадрата вычисляется по формуле: S = a^2 , где а — сторона квадрата. \nПодставляем известное значение площади : a^2 = 64. Отсюда а = sqrt(64) = 8 см.\nПериметр квадрата : Р = 4а = 4 * 8 = 32 см."},
        {"14. Сколько корней имеет уравнение х2+6х+9=0?", {"0", "1", "2", "Бесконечно много"}, 1, false, "Уравнение является полным квадратом: (х + 3)^2  = 0, поэтому имеет один корень."},
        {"15. У двух матерей и двух дочерей есть 3 яблока. Каждой из них досталось по целому яблоку. Как это возможно?", {"Одна яблоко разрезали пополам", "Это бабушка, мать и дочь", "Они поделились", "Одно яблоко было ненастоящее"}, 1, false, "Одна женщина одновременно является и дочерью (для своей матери), и матерью (для своей дочери)."},
        {"16. Вы находитесь в комнате с дверью. Снаружи комнаты есть три выключателя, каждый из которых включает одну из трех лампочек в комнате. Дверь закрыта, и вы не видите, что происходит внутри. Можно воспользоваться выключателями только при открытой двери. Как определить, какой выключатель к какой лампочке относится, сделав только один выход из комнаты?", {"Включить один выключатель, подождать, выключить его и включить другой", "Включить два выключателя сразу", "Включить один выключатель на долгое время, потом выключить его и включить другой", "Позвать на помощь"}, 2, false, "Включаем первый выключатель и ждем 5-10 минут. Выключаем первый выключатель и сразу включаем второй. Быстро заходим в комнату. Теперь смотрим : одна лампочка горит — это та, которую включили второй(работает от второго выключателя).Ощупываем две оставшиеся : одна лампочка будет теплой — это та, которую включили первой(работает от первого выключателя).Холодная лампочка — та, которую не включали(работает от третьего выключателя)."}
    };

    questions = defaultQuestions;
}

void MainFrame::ClearMainSizer()
{
    if (mainSizer->GetItemCount() > 0) {
        mainSizer->Clear(true);
    }
    startPanel = NULL;
    gameBoardPanel = NULL;
    questionPanel = NULL;
    fractalPanel = NULL;
}

void MainFrame::ShowStartPanel()
{
    ClearMainSizer();
    startPanel = new StartPanel(this, this);
    mainSizer->Add(startPanel, 1, wxEXPAND);
    Layout();
}

void MainFrame::StartGame()
{
    ClearMainSizer();
    gameBoardPanel = new GameBoardPanel(this, this);
    mainSizer->Add(gameBoardPanel, 1, wxEXPAND);
    Layout();
}

void MainFrame::ShowQuestion(int questionIndex)
{
    ClearMainSizer();
    questionPanel = new QuestionPanel(this, this, questionIndex);
    mainSizer->Add(questionPanel, 1, wxEXPAND);
    Layout();
}

void MainFrame::ReturnToBoard()
{
    ClearMainSizer();
    gameBoardPanel = new GameBoardPanel(this, this);
    mainSizer->Add(gameBoardPanel, 1, wxEXPAND);
    Layout();
}

void MainFrame::OnClose(wxCloseEvent& event)
{
    Destroy();
}